<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Fix Selected Days & Status - Auto Copy & Open</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,sans-serif;background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);color:#fff;padding:20px;display:flex;align-items:center;justify-content:center;min-height:100vh}
.container{background:#1e293b;border:4px solid#10b981;border-radius:24px;padding:60px;max-width:800px;box-shadow:0 25px 50px -12px rgba(0,0,0,0.9)}
h1{color:#10b981;font-size:42px;margin-bottom:15px;text-align:center;text-shadow:0 0 20px rgba(16,185,129,0.5)}
.subtitle{color:#94a3b8;text-align:center;font-size:18px;margin-bottom:30px}
.step{background:#334155;padding:25px;border-radius:16px;margin:15px 0;border-left:6px solid#10b981;font-size:20px;font-weight:700;box-shadow:0 10px 15px -3px rgba(0,0,0,0.3)}
.step-num{display:inline-block;background:#10b981;color:#000;width:45px;height:45px;border-radius:50%;text-align:center;line-height:45px;margin-right:15px;font-size:24px;font-weight:900}
.btn{background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;padding:25px 50px;border-radius:16px;font-size:28px;font-weight:900;cursor:pointer;width:100%;margin:15px 0;transition:all .3s;box-shadow:0 10px 25px rgba(16,185,129,0.4);text-decoration:none;display:block;text-align:center}
.btn:hover{transform:translateY(-3px);box-shadow:0 15px 35px rgba(16,185,129,0.6)}
.btn:active{transform:translateY(0)}
.status{text-align:center;font-size:32px;margin:30px 0;padding:25px;background:#0f172a;border-radius:16px;font-weight:700}
.copied{animation:flash .5s ease-in-out}
@keyframes flash{0%,100%{background:#334155}50%{background:#10b981}}
.emoji{font-size:64px;display:block;margin:15px 0}
.fix-list{background:#0f172a;padding:20px;border-radius:12px;margin:20px 0;font-size:16px;line-height:1.8}
.fix-list li{margin:10px 0;padding-left:30px;position:relative}
.fix-list li:before{content:'âœ…';position:absolute;left:0;font-size:20px}
</style>
</head>
<body>
<div class="container">
<h1>Fix Selected Days & Mark as Not Live</h1>
<div class="subtitle">Automatic Fix for Admin Panel & Recurring Meetings</div>

<div class="fix-list">
<strong style="color:#10b981;font-size:20px">Kya fix hoga:</strong>
<li>Mark as Not Live button ki error</li>
<li>Selected days check (Prashant Blockista jaisi meetings)</li>
<li>Refresh pe bhi skip days respect hogi</li>
<li>Aaj se recurring meetings sirf selected days pe hi banegi</li>
</div>

<div class="status" id="status">
<span class="emoji">ðŸ“‹</span>
SQL Copied to Clipboard!
</div>

<div class="step">
<span class="step-num">1</span>
SQL already copied!
</div>
<div class="step">
<span class="step-num">2</span>
Click button below
</div>
<div class="step">
<span class="step-num">3</span>
Paste & RUN in dashboard
</div>

<a href="https://supabase.com/dashboard/project/fkypxitgnfqbfplxokve/sql" target="_blank" class="btn" onclick="openDashboard()">
OPEN SUPABASE SQL EDITOR
</a>

<div style="text-align:center;margin-top:40px;font-size:18px;color:#94a3b8;line-height:1.8">
<strong style="color:#fbbf24">After opening:</strong><br>
Press Ctrl+V (or Cmd+V on Mac) to paste<br>
Click the green RUN button<br>
Done! Refresh your app
</div>
</div>

<textarea id="sql" style="position:absolute;left:-9999px">-- Fix Selected Days and Status Issues
-- 1. Fix Status Constraint
ALTER TABLE meetings DROP CONSTRAINT IF EXISTS meetings_status_check;
ALTER TABLE meetings ADD CONSTRAINT meetings_status_check CHECK (status IN ('active', 'not_live', 'cancelled', 'wrong_credentials'));

-- 2. Fix ensure_client_recurring_meetings to check selected_days
CREATE OR REPLACE FUNCTION ensure_client_recurring_meetings(p_client_name text)
RETURNS integer AS $$
DECLARE
  template_rec RECORD;
  meeting_exists boolean;
  new_meeting_id uuid;
  created_count integer := 0;
  current_day_of_week integer;
  should_create boolean;
BEGIN
  current_day_of_week := EXTRACT(DOW FROM CURRENT_DATE)::integer;

  FOR template_rec IN
    SELECT * FROM recurring_meeting_templates
    WHERE client_name = p_client_name AND is_active = true
  LOOP
    should_create := false;

    IF template_rec.selected_days IS NULL OR jsonb_array_length(template_rec.selected_days) = 0 THEN
      should_create := true;
    ELSIF template_rec.selected_days ? current_day_of_week::text THEN
      should_create := true;
    END IF;

    IF NOT should_create THEN
      CONTINUE;
    END IF;

    SELECT EXISTS (
      SELECT 1 FROM meetings
      WHERE recurring_template_id = template_rec.id
      AND scheduled_date = CURRENT_DATE
      AND status != 'cancelled'
    ) INTO meeting_exists;

    IF NOT meeting_exists THEN
      INSERT INTO meetings (
        client_name, meeting_name, meeting_id, password, hour, minutes, time_period,
        member_count, member_type, scheduled_date, is_recurring, recurring_template_id,
        auto_created, is_instant, attended, status
      ) VALUES (
        template_rec.client_name, template_rec.meeting_name, template_rec.meeting_id,
        template_rec.password, template_rec.hour, template_rec.minutes, template_rec.time_period,
        template_rec.member_count, template_rec.member_type, CURRENT_DATE, true, template_rec.id,
        true, false, false, 'active'
      ) RETURNING id INTO new_meeting_id;

      UPDATE recurring_meeting_templates
      SET last_created_date = CURRENT_DATE, updated_at = now()
      WHERE id = template_rec.id;

      created_count := created_count + 1;
    END IF;
  END LOOP;

  RETURN created_count;
END;
$$ LANGUAGE plpgsql;

-- 3. Fix create_todays_recurring_meetings to check selected_days
CREATE OR REPLACE FUNCTION create_todays_recurring_meetings()
RETURNS TABLE(created_count integer, meeting_name text, client_name text) AS $$
DECLARE
  template_rec RECORD;
  meeting_exists boolean;
  new_meeting_id uuid;
  total_created integer := 0;
  current_day_of_week integer;
  should_create boolean;
BEGIN
  current_day_of_week := EXTRACT(DOW FROM CURRENT_DATE)::integer;

  FOR template_rec IN
    SELECT * FROM recurring_meeting_templates WHERE is_active = true
  LOOP
    should_create := false;

    IF template_rec.selected_days IS NULL OR jsonb_array_length(template_rec.selected_days) = 0 THEN
      should_create := true;
    ELSIF template_rec.selected_days ? current_day_of_week::text THEN
      should_create := true;
    END IF;

    IF NOT should_create THEN
      CONTINUE;
    END IF;

    SELECT EXISTS (
      SELECT 1 FROM meetings
      WHERE recurring_template_id = template_rec.id
      AND scheduled_date = CURRENT_DATE
      AND status != 'cancelled'
    ) INTO meeting_exists;

    IF NOT meeting_exists THEN
      INSERT INTO meetings (
        client_name, meeting_name, meeting_id, password, hour, minutes, time_period,
        member_count, member_type, scheduled_date, is_recurring, recurring_template_id,
        auto_created, is_instant, attended, status
      ) VALUES (
        template_rec.client_name, template_rec.meeting_name, template_rec.meeting_id,
        template_rec.password, template_rec.hour, template_rec.minutes, template_rec.time_period,
        template_rec.member_count, template_rec.member_type, CURRENT_DATE, true, template_rec.id,
        true, false, false, 'active'
      ) RETURNING id INTO new_meeting_id;

      UPDATE recurring_meeting_templates
      SET last_created_date = CURRENT_DATE, updated_at = now()
      WHERE id = template_rec.id;

      total_created := total_created + 1;
      RETURN QUERY SELECT 1::integer, template_rec.meeting_name, template_rec.client_name;
    END IF;
  END LOOP;

  IF total_created = 0 THEN
    RETURN QUERY SELECT 0::integer, 'No new meetings created'::text, ''::text;
  END IF;

  RETURN;
END;
$$ LANGUAGE plpgsql;

-- 4. Fix create_daily_meetings to check selected_days
CREATE OR REPLACE FUNCTION create_daily_meetings()
RETURNS integer AS $$
DECLARE
  created_count integer := 0;
  recurring_rec RECORD;
  today_str text;
  today_dow integer;
  meeting_exists boolean;
  is_excluded boolean;
  should_run_today boolean;
BEGIN
  today_str := CURRENT_DATE::text;
  today_dow := EXTRACT(DOW FROM CURRENT_DATE)::integer;

  FOR recurring_rec IN
    SELECT * FROM recurring_meeting_templates WHERE is_active = true
  LOOP
    should_run_today := false;

    IF recurring_rec.selected_days IS NULL OR jsonb_array_length(recurring_rec.selected_days) = 0 THEN
      should_run_today := true;
    ELSIF recurring_rec.selected_days ? today_dow::text THEN
      should_run_today := true;
    END IF;

    IF NOT should_run_today THEN
      CONTINUE;
    END IF;

    IF recurring_rec.excluded_dates IS NOT NULL THEN
      SELECT EXISTS (
        SELECT 1 FROM jsonb_array_elements_text(recurring_rec.excluded_dates) AS excluded_date
        WHERE excluded_date = today_str
      ) INTO is_excluded;

      IF is_excluded THEN
        CONTINUE;
      END IF;
    END IF;

    SELECT EXISTS (
      SELECT 1 FROM meetings
      WHERE recurring_template_id = recurring_rec.id
      AND scheduled_date = CURRENT_DATE
      AND status != 'cancelled'
    ) INTO meeting_exists;

    IF NOT meeting_exists THEN
      INSERT INTO meetings (
        client_id, client_name, meeting_name, meeting_id, password, hour, minutes, time_period,
        member_count, member_type, scheduled_date, is_recurring, recurring_template_id,
        auto_created, is_instant, attended, status
      ) VALUES (
        recurring_rec.client_id, recurring_rec.client_name, recurring_rec.meeting_name,
        recurring_rec.meeting_id, recurring_rec.password, recurring_rec.hour, recurring_rec.minutes,
        recurring_rec.time_period, recurring_rec.member_count, recurring_rec.member_type,
        CURRENT_DATE, true, recurring_rec.id, true, false, false, 'active'
      );

      created_count := created_count + 1;

      UPDATE recurring_meeting_templates
      SET last_created_date = CURRENT_DATE, updated_at = now()
      WHERE id = recurring_rec.id;
    END IF;
  END LOOP;

  RETURN created_count;
END;
$$ LANGUAGE plpgsql;</textarea>

<script>
window.onload=function(){
const t=document.getElementById('sql');
t.select();
document.execCommand('copy');
document.getElementById('status').classList.add('copied');
setTimeout(()=>document.getElementById('status').classList.remove('copied'),500)
};
function openDashboard(){
document.getElementById('status').innerHTML='<span class="emoji">âœ…</span>Dashboard Opened!<br><span style="font-size:20px;color:#94a3b8">Paste SQL and click RUN</span>';
}
</script>
</body>
</html>