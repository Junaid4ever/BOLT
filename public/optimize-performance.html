<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Performance Optimization</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 2rem;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 2rem;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #667eea;
      margin-bottom: 1rem;
      font-size: 2rem;
    }
    .subtitle {
      color: #666;
      margin-bottom: 2rem;
    }
    .section {
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: #f8f9fa;
      border-radius: 10px;
    }
    .section h2 {
      color: #333;
      margin-bottom: 1rem;
      font-size: 1.3rem;
    }
    .log {
      background: #1e1e1e;
      color: #f0f0f0;
      padding: 1rem;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 1rem;
    }
    .log-line {
      margin-bottom: 0.3rem;
      line-height: 1.5;
    }
    .success { color: #4ade80; }
    .error { color: #f87171; }
    .warning { color: #fbbf24; }
    .info { color: #60a5fa; }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 1rem 2rem;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    button:hover { transform: scale(1.05); }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .stat-card {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #667eea;
    }
    .stat-label {
      color: #666;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ Performance Optimization</h1>
    <p class="subtitle">Optimize database and storage for faster performance</p>

    <button id="startBtn" onclick="startOptimization()">Start Optimization</button>

    <div class="section">
      <h2>Progress Log</h2>
      <div id="log" class="log"></div>
    </div>

    <div class="section">
      <h2>Statistics</h2>
      <div class="stats" id="stats"></div>
    </div>
  </div>

  <script type="module">
    const SUPABASE_URL = 'https://fkypxitgnfqbfplxokve.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZreXB4aXRnbmZxYmZwbHhva3ZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjE0ODksImV4cCI6MjA3NjE5NzQ4OX0.Swk4AqJrRBNnEIdSGS3QjfU-okNKN2LGSL43Ha1h4Cc';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const line = document.createElement('div');
      line.className = `log-line ${type}`;
      line.textContent = message;
      logDiv.appendChild(line);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    async function createBuckets() {
      log('üì¶ Creating storage buckets...', 'info');

      const buckets = [
        { id: 'screenshots', name: 'Meeting Screenshots', public: false },
        { id: 'payment-screenshots', name: 'Payment Screenshots', public: false },
        { id: 'advance-screenshots', name: 'Advance Screenshots', public: false },
        { id: 'qr-codes', name: 'QR Codes', public: true }
      ];

      for (const bucket of buckets) {
        try {
          const { error } = await supabase.storage.createBucket(bucket.id, {
            public: bucket.public,
            fileSizeLimit: 5242880
          });

          if (error && !error.message.includes('already exists')) {
            log(`  ‚ùå ${bucket.name}: ${error.message}`, 'error');
          } else {
            log(`  ‚úÖ ${bucket.name} created/exists`, 'success');
          }
        } catch (err) {
          log(`  ‚ùå ${bucket.name}: ${err.message}`, 'error');
        }
      }
    }

    async function createIndex(name, sql) {
      try {
        const { error } = await supabase.rpc('exec_sql', { sql_query: sql });
        if (error) {
          if (error.message.includes('already exists') || error.message.includes('does not exist')) {
            log(`  ‚ö†Ô∏è  ${name}: Already exists or needs manual creation`, 'warning');
          } else {
            log(`  ‚ùå ${name}: ${error.message}`, 'error');
          }
        } else {
          log(`  ‚úÖ ${name} created`, 'success');
        }
      } catch (err) {
        log(`  ‚ö†Ô∏è  ${name}: ${err.message}`, 'warning');
      }
    }

    async function createIndexes() {
      log('\nüìä Creating performance indexes...', 'info');

      const indexes = [
        ['meetings_scheduled_status', `CREATE INDEX IF NOT EXISTS idx_meetings_scheduled_date_status ON meetings(scheduled_date, status)`],
        ['meetings_client_scheduled', `CREATE INDEX IF NOT EXISTS idx_meetings_client_scheduled ON meetings(client_name, scheduled_date DESC)`],
        ['meetings_attended', `CREATE INDEX IF NOT EXISTS idx_meetings_attended_date ON meetings(attended, scheduled_date DESC) WHERE attended = true`],
        ['daily_dues_client', `CREATE INDEX IF NOT EXISTS idx_daily_dues_client_date ON daily_dues(client_id, due_date DESC)`],
        ['payments_client', `CREATE INDEX IF NOT EXISTS idx_payments_client_date ON payments(client_name, payment_date DESC)`],
        ['advance_payments', `CREATE INDEX IF NOT EXISTS idx_advance_payments_client ON advance_payments(client_id, is_fully_used)`],
        ['users_role', `CREATE INDEX IF NOT EXISTS idx_users_role ON users(role)`],
        ['notifications_unread', `CREATE INDEX IF NOT EXISTS idx_notifications_unread ON notifications(user_id, is_read, created_at DESC) WHERE is_read = false`]
      ];

      for (const [name, sql] of indexes) {
        await createIndex(name, sql);
      }
    }

    async function cleanOldData() {
      log('\nüßπ Cleaning old data...', 'info');

      try {
        const { data: oldNotifications, error: notifError } = await supabase
          .from('notifications')
          .delete()
          .lt('created_at', new Date(Date.now() - 90 * 24 * 60 * 60 * 1000).toISOString());

        if (!notifError) {
          log('  ‚úÖ Deleted old notifications (90+ days)', 'success');
        }
      } catch (err) {
        log('  ‚ö†Ô∏è  Could not delete old notifications', 'warning');
      }
    }

    async function showStats() {
      log('\nüìà Fetching statistics...', 'info');

      const statsDiv = document.getElementById('stats');
      statsDiv.innerHTML = '';

      const tables = ['meetings', 'daily_dues', 'payments', 'users', 'advance_payments', 'notifications'];

      for (const table of tables) {
        try {
          const { count } = await supabase.from(table).select('*', { count: 'exact', head: true });

          const card = document.createElement('div');
          card.className = 'stat-card';
          card.innerHTML = `
            <div class="stat-value">${count?.toLocaleString() || 0}</div>
            <div class="stat-label">${table.replace(/_/g, ' ')}</div>
          `;
          statsDiv.appendChild(card);

          log(`  ‚úÖ ${table}: ${count?.toLocaleString() || 0} rows`, 'success');
        } catch (err) {
          log(`  ‚ö†Ô∏è  ${table}: Could not count`, 'warning');
        }
      }

      try {
        const { data: buckets } = await supabase.storage.listBuckets();
        log(`\nüì¶ Storage Buckets: ${buckets?.length || 0} total`, 'info');
        buckets?.forEach(b => {
          log(`  ${b.public ? 'üåç' : 'üîí'} ${b.name}`, 'info');
        });
      } catch (err) {
        log('  ‚ö†Ô∏è  Could not fetch buckets', 'warning');
      }
    }

    window.startOptimization = async function() {
      const btn = document.getElementById('startBtn');
      btn.disabled = true;
      btn.textContent = 'Running...';

      document.getElementById('log').innerHTML = '';
      document.getElementById('stats').innerHTML = '';

      log('üöÄ Starting Performance Optimization\n', 'info');
      log('='.repeat(50), 'info');

      try {
        await createBuckets();
        await createIndexes();
        await cleanOldData();
        await showStats();

        log('\n' + '='.repeat(50), 'info');
        log('\nüéâ Optimization Complete!', 'success');
        log('‚úÖ Storage buckets configured', 'success');
        log('‚úÖ Performance indexes attempted', 'success');
        log('‚úÖ Old data cleaned', 'success');
        log('\nüí° Website should be faster now!', 'info');
        log('\nNote: Some indexes may need manual creation via Supabase SQL editor', 'warning');
      } catch (err) {
        log(`\n‚ùå Error: ${err.message}`, 'error');
      }

      btn.disabled = false;
      btn.textContent = 'Run Again';
    };
  </script>
</body>
</html>
