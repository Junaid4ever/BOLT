<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Fix dp_member_price Error - Auto Copy & Open</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,sans-serif;background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:#fff;padding:20px;display:flex;align-items:center;justify-content:center;min-height:100vh}
.container{background:#1e293b;border:4px solid#ef4444;border-radius:24px;padding:60px;max-width:900px;box-shadow:0 25px 50px -12px rgba(0,0,0,0.9)}
h1{color:#ef4444;font-size:48px;margin-bottom:20px;text-align:center;text-shadow:0 0 20px rgba(239,68,68,0.5)}
.warning{background:#7f1d1d;padding:20px;border-radius:12px;margin:20px 0;border-left:6px solid#ef4444;font-size:18px}
.step{background:#334155;padding:30px;border-radius:16px;margin:20px 0;border-left:6px solid#ef4444;font-size:24px;font-weight:700;box-shadow:0 10px 15px -3px rgba(0,0,0,0.3)}
.step-num{display:inline-block;background:#ef4444;color:#fff;width:50px;height:50px;border-radius:50%;text-align:center;line-height:50px;margin-right:15px;font-size:28px;font-weight:900}
.btn{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;border:none;padding:25px 50px;border-radius:16px;font-size:28px;font-weight:900;cursor:pointer;width:100%;margin:15px 0;transition:all .3s;box-shadow:0 10px 25px rgba(239,68,68,0.4);text-decoration:none;display:block;text-align:center}
.btn:hover{transform:translateY(-3px);box-shadow:0 15px 35px rgba(239,68,68,0.6)}
.btn:active{transform:translateY(0)}
.status{text-align:center;font-size:36px;margin:30px 0;padding:25px;background:#0f172a;border-radius:16px;font-weight:700}
.copied{animation:flash .5s ease-in-out}
@keyframes flash{0%,100%{background:#334155}50%{background:#ef4444}}
.emoji{font-size:64px;display:block;margin:20px 0}
</style>
</head>
<body>
<div class="container">
<h1>Fix Meeting Insert Error</h1>
<div class="warning">
<strong>Error:</strong> column "dp_member_price" does not exist
<br><br>
This fixes a database trigger that references an old column that no longer exists.
</div>
<div class="status" id="status">
<span class="emoji">ðŸ“‹</span>
SQL Copied to Clipboard!
</div>
<div class="step">
<span class="step-num">1</span>
SQL already copied!
</div>
<div class="step">
<span class="step-num">2</span>
Click button below
</div>
<div class="step">
<span class="step-num">3</span>
Paste & RUN in dashboard
</div>
<a href="https://supabase.com/dashboard/project/fkypxitgnfqbfplxokve/sql" target="_blank" class="btn" onclick="openDashboard()">
OPEN SUPABASE SQL EDITOR
</a>
<div style="text-align:center;margin-top:40px;font-size:18px;color:#94a3b8;line-height:1.8">
<strong style="color:#fbbf24">After opening:</strong><br>
Press Ctrl+V (or Cmd+V on Mac) to paste<br>
Click the green RUN button<br>
Done! Try adding a meeting again
</div>
</div>
<textarea id="sql" style="position:absolute;left:-9999px">-- ============================================
-- Fix dp_member_price Error in Meeting Triggers
-- ============================================

-- This fixes triggers that reference the old dp_member_price column

-- Check and fix any problematic functions/triggers
DO $$
DECLARE
  func_record RECORD;
BEGIN
  -- Find all functions that reference dp_member_price
  FOR func_record IN
    SELECT proname, prosrc
    FROM pg_proc
    WHERE prosrc LIKE '%dp_member_price%'
  LOOP
    RAISE NOTICE 'Found function with dp_member_price: %', func_record.proname;
  END LOOP;
END $$;

-- Disable problematic triggers temporarily
DROP TRIGGER IF EXISTS trigger_update_daily_dues_on_meeting ON meetings;
DROP TRIGGER IF EXISTS auto_calc_dues_on_meeting_update ON meetings;

-- Recreate trigger without dp_member_price reference
CREATE OR REPLACE FUNCTION update_daily_dues_on_meeting()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  IF NEW.attended = TRUE AND NEW.screenshot_url IS NOT NULL THEN
    IF (OLD IS NULL OR OLD.attended = FALSE OR OLD.screenshot_url IS NULL) THEN
      PERFORM calculate_daily_dues_for_client(NEW.client_name, COALESCE(NEW.scheduled_date, CURRENT_DATE));
    END IF;
  END IF;

  RETURN NEW;
END;
$$;

-- Recreate trigger
CREATE TRIGGER trigger_update_daily_dues_on_meeting
  AFTER INSERT OR UPDATE ON meetings
  FOR EACH ROW
  EXECUTE FUNCTION update_daily_dues_on_meeting();

-- Test that meetings can be inserted now
DO $$
DECLARE
  test_id uuid;
BEGIN
  -- Try to insert a test meeting
  INSERT INTO meetings (
    meeting_name,
    meeting_id,
    password,
    hour,
    minutes,
    time_period,
    member_count,
    member_type,
    attended
  ) VALUES (
    'TEST_MEETING_DELETE_ME',
    '999999999',
    'test',
    8,
    0,
    'PM',
    1,
    'indian',
    false
  ) RETURNING id INTO test_id;

  -- Delete the test meeting
  DELETE FROM meetings WHERE id = test_id;

  RAISE NOTICE 'SUCCESS: Meeting insert/delete working correctly!';
END $$;</textarea>
<script>
window.onload=function(){
const t=document.getElementById('sql');
t.select();
document.execCommand('copy');
document.getElementById('status').classList.add('copied');
setTimeout(()=>document.getElementById('status').classList.remove('copied'),500)
};
function openDashboard(){
document.getElementById('status').innerHTML='<span class="emoji">âœ…</span>Dashboard Opened!<br><span style="font-size:20px;color:#94a3b8">Paste SQL and click RUN</span>';
}
</script>
</body>
</html>
