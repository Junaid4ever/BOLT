<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Auto-Migrating Database...</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body{font-family:system-ui,sans-serif;background:#1e293b;color:#fff;padding:40px;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0}
.container{background:#0f172a;border:3px solid #10b981;border-radius:20px;padding:50px;max-width:600px;text-align:center;box-shadow:0 25px 50px rgba(0,0,0,0.5)}
h1{color:#10b981;margin:0 0 30px 0;font-size:36px}
.status{font-size:20px;margin:20px 0;line-height:1.8}
.success{color:#10b981;font-weight:700;font-size:24px;margin:30px 0}
.error{color:#ef4444;font-weight:700;font-size:20px;margin:30px 0}
.spinner{border:4px solid #334155;border-top-color:#10b981;border-radius:50%;width:60px;height:60px;animation:spin 1s linear infinite;margin:30px auto}
@keyframes spin{to{transform:rotate(360deg)}}
.manual{background:#ef4444;color:#fff;padding:20px;border-radius:12px;margin:30px 0;text-align:left;font-size:16px}
.btn{background:#10b981;color:#fff;border:none;padding:15px 30px;border-radius:10px;font-size:18px;font-weight:700;cursor:pointer;margin:10px;text-decoration:none;display:inline-block}
.btn:hover{background:#059669}
</style>
</head>
<body>
<div class="container">
<h1>üîÑ Auto-Migrating Database</h1>
<div id="status" class="status">
<div class="spinner"></div>
<div>Applying Co-Host system changes...</div>
</div>
</div>
<script>
const supabase = window.supabase.createClient(
  'https://fkypxitgnfqbfplxokve.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZreXB4aXRnbmZxYmZwbHhva3ZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjE0ODksImV4cCI6MjA3NjE5NzQ4OX0.Swk4AqJrRBNnEIdSGS3QjfU-okNKN2LGSL43Ha1h4Cc'
);

async function applyMigration() {
  const sql = `
DO $$ BEGIN IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'users' AND column_name = 'is_cohost') THEN ALTER TABLE users ADD COLUMN is_cohost BOOLEAN DEFAULT false; END IF; END $$;
DO $$ BEGIN IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'users' AND column_name = 'parent_user_id') THEN ALTER TABLE users ADD COLUMN parent_user_id uuid REFERENCES users(id) ON DELETE SET NULL; END IF; END $$;
DO $$ BEGIN IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'users' AND column_name = 'cohost_prefix') THEN ALTER TABLE users ADD COLUMN cohost_prefix TEXT UNIQUE; END IF; END $$;
CREATE TABLE IF NOT EXISTS cohost_requests (id uuid PRIMARY KEY DEFAULT gen_random_uuid(), user_id uuid NOT NULL REFERENCES users(id) ON DELETE CASCADE, status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected')), requested_at timestamptz DEFAULT now(), admin_response_at timestamptz, admin_response_by TEXT, UNIQUE(user_id, requested_at));
ALTER TABLE cohost_requests ENABLE ROW LEVEL SECURITY;
DROP POLICY IF EXISTS "Users can view their own requests" ON cohost_requests;
DROP POLICY IF EXISTS "Users can insert their own requests" ON cohost_requests;
DROP POLICY IF EXISTS "Only admins can update requests" ON cohost_requests;
CREATE POLICY "Users can view their own requests" ON cohost_requests FOR SELECT USING (true);
CREATE POLICY "Users can insert their own requests" ON cohost_requests FOR INSERT WITH CHECK (true);
CREATE POLICY "Only admins can update requests" ON cohost_requests FOR UPDATE USING (true);
CREATE INDEX IF NOT EXISTS idx_cohost_requests_user_id ON cohost_requests(user_id);
CREATE INDEX IF NOT EXISTS idx_cohost_requests_status ON cohost_requests(status);
CREATE INDEX IF NOT EXISTS idx_users_parent_user_id ON users(parent_user_id);
CREATE INDEX IF NOT EXISTS idx_users_cohost_prefix ON users(cohost_prefix);
CREATE INDEX IF NOT EXISTS idx_users_is_cohost ON users(is_cohost);
  `.trim();

  try {
    const { data, error } = await supabase.rpc('exec_sql', { sql_query: sql });
    
    if (error) {
      if (error.message.includes('function') && error.message.includes('does not exist')) {
        showManualInstructions();
      } else {
        document.getElementById('status').innerHTML = `
          <div class="error">Migration Failed</div>
          <div style="color:#94a3b8;font-size:16px;margin:20px 0">${error.message}</div>
          <div style="color:#fbbf24;font-size:18px;margin:20px">Trying manual method...</div>
        `;
        setTimeout(showManualInstructions, 2000);
      }
    } else {
      await verifyMigration();
    }
  } catch (e) {
    document.getElementById('status').innerHTML = `
      <div class="error">Error</div>
      <div style="color:#94a3b8">${e.message}</div>
    `;
    setTimeout(showManualInstructions, 2000);
  }
}

async function verifyMigration() {
  const { error } = await supabase
    .from('users')
    .select('cohost_prefix')
    .limit(1);

  if (error && error.message.includes('column')) {
    showManualInstructions();
  } else {
    document.getElementById('status').innerHTML = `
      <div class="success">‚úÖ Migration Applied Successfully!</div>
      <div style="color:#94a3b8;font-size:18px;margin:20px 0">Co-Host system is now ready</div>
      <a href="/" class="btn">Go to Dashboard</a>
    `;
    setTimeout(() => {
      window.location.href = '/';
    }, 3000);
  }
}

function showManualInstructions() {
  document.getElementById('status').innerHTML = `
    <div class="error">‚ö†Ô∏è Automatic Migration Not Possible</div>
    <div class="manual">
      <strong style="color:#fff">Manual SQL Required:</strong><br><br>
      1. <a href="https://supabase.com/dashboard/project/fkypxitgnfqbfplxokve/sql" target="_blank" style="color:#60a5fa">Click here to open SQL Editor</a><br>
      2. Copy the SQL from <strong>RUN_THIS_SQL_IN_SUPABASE.sql</strong><br>
      3. Paste and click RUN<br><br>
      <strong style="color:#fbbf24">Why?</strong> Database schema changes require admin privileges that can only be executed through Supabase Dashboard.
    </div>
    <a href="https://supabase.com/dashboard/project/fkypxitgnfqbfplxokve/sql" target="_blank" class="btn">Open SQL Editor</a>
  `;
}

applyMigration();
</script>
</body>
</html>
