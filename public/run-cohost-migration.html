<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Run Co-host Migration</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 800px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 28px;
    }
    p {
      color: #666;
      margin-bottom: 30px;
      line-height: 1.6;
    }
    .sql-box {
      background: #f7f7f7;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 30px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 40px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      width: 100%;
    }
    .button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
    }
    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 10px;
      font-weight: 500;
    }
    .status.loading {
      background: #fff3cd;
      color: #856404;
      border: 2px solid #ffc107;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 2px solid #28a745;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 2px solid #dc3545;
    }
    .manual-instructions {
      background: #e7f3ff;
      border-left: 4px solid #2196F3;
      padding: 20px;
      margin-top: 20px;
      border-radius: 8px;
    }
    .manual-instructions h3 {
      color: #1976D2;
      margin-bottom: 10px;
    }
    .manual-instructions ol {
      margin-left: 20px;
      color: #555;
    }
    .manual-instructions li {
      margin: 8px 0;
      line-height: 1.6;
    }
    .manual-instructions a {
      color: #2196F3;
      font-weight: 600;
      text-decoration: none;
    }
    .manual-instructions a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöÄ Co-host Migration Runner</h1>
    <p>This will add co-host support to the payment_methods table. Click the button below to run the migration automatically.</p>

    <div class="sql-box" id="sqlDisplay"></div>

    <button class="button" id="runButton" onclick="runMigration()">
      Run Migration Now
    </button>

    <div id="status"></div>

    <div class="manual-instructions">
      <h3>üìã Manual Instructions (if automatic fails)</h3>
      <ol>
        <li>Go to <a href="https://supabase.com/dashboard/project/fkypxitgnfqbfplxokve/sql" target="_blank">Supabase SQL Editor</a></li>
        <li>Copy the SQL from the box above</li>
        <li>Paste it in the SQL Editor</li>
        <li>Click "Run" button</li>
        <li>Refresh this page and click the button again to verify</li>
      </ol>
    </div>
  </div>

  <script>
    const { createClient } = supabase;

    const SUPABASE_URL = 'https://fkypxitgnfqbfplxokve.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZreXB4aXRnbmZxYmZwbHhva3ZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MjE0ODksImV4cCI6MjA3NjE5NzQ4OX0.Swk4AqJrRBNnEIdSGS3QjfU-okNKN2LGSL43Ha1h4Cc';

    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const SQL = `-- Add Co-host Support to Payment Methods
ALTER TABLE payment_methods
ADD COLUMN IF NOT EXISTS cohost_user_id uuid REFERENCES users(id) ON DELETE CASCADE;

-- Create index for faster lookups
CREATE INDEX IF NOT EXISTS idx_payment_methods_cohost_user_id
ON payment_methods(cohost_user_id);

-- Drop existing policies
DROP POLICY IF EXISTS "Anyone can read payment methods" ON payment_methods;
DROP POLICY IF EXISTS "Authenticated users can update payment methods" ON payment_methods;

-- Allow everyone to read admin payment methods (cohost_user_id IS NULL)
CREATE POLICY "Anyone can read admin payment methods"
  ON payment_methods
  FOR SELECT
  USING (cohost_user_id IS NULL);

-- Allow users to read their parent cohost's payment methods
CREATE POLICY "Users can read their cohost payment methods"
  ON payment_methods
  FOR SELECT
  USING (
    cohost_user_id IN (
      SELECT parent_user_id FROM users WHERE id = auth.uid()
    )
  );

-- Allow cohosts to read their own payment methods
CREATE POLICY "Cohosts can read own payment methods"
  ON payment_methods
  FOR SELECT
  USING (cohost_user_id = auth.uid());

-- Allow cohosts to insert their own payment methods
CREATE POLICY "Cohosts can insert own payment methods"
  ON payment_methods
  FOR INSERT
  WITH CHECK (cohost_user_id = auth.uid());

-- Allow cohosts to update their own payment methods
CREATE POLICY "Cohosts can update own payment methods"
  ON payment_methods
  FOR UPDATE
  USING (cohost_user_id = auth.uid())
  WITH CHECK (cohost_user_id = auth.uid());

-- Allow admin to manage all payment methods
CREATE POLICY "Admin can manage all payment methods"
  ON payment_methods
  FOR ALL
  USING (true)
  WITH CHECK (true);`;

    document.getElementById('sqlDisplay').textContent = SQL;

    async function runMigration() {
      const button = document.getElementById('runButton');
      const statusDiv = document.getElementById('status');

      button.disabled = true;
      statusDiv.className = 'status loading';
      statusDiv.textContent = '‚è≥ Running migration... Please wait...';

      try {
        // First check if column already exists
        const { data: checkData, error: checkError } = await supabaseClient
          .from('payment_methods')
          .select('cohost_user_id')
          .limit(1);

        if (!checkError) {
          statusDiv.className = 'status success';
          statusDiv.innerHTML = '‚úÖ Migration already applied! The cohost_user_id column exists.<br><br>Your co-host features are ready to use!';
          button.textContent = 'Migration Complete ‚úì';
          return;
        }

        // Try to run via RPC if available
        const { data, error } = await supabaseClient.rpc('exec_sql', {
          sql_query: SQL
        });

        if (error) {
          throw error;
        }

        statusDiv.className = 'status success';
        statusDiv.innerHTML = '‚úÖ Migration completed successfully!<br><br>Co-host payment methods support has been enabled!';
        button.textContent = 'Migration Complete ‚úì';

      } catch (error) {
        console.error('Migration error:', error);
        statusDiv.className = 'status error';
        statusDiv.innerHTML = `‚ùå Automatic migration failed: ${error.message}<br><br>
          <strong>Please follow the manual instructions below to run the SQL.</strong><br><br>
          The SQL code is displayed in the box above. Copy it and run it in the Supabase SQL Editor.`;
        button.disabled = false;
        button.textContent = 'Try Again';
      }
    }

    // Auto-check on load
    window.addEventListener('load', async () => {
      try {
        const { data, error } = await supabaseClient
          .from('payment_methods')
          .select('cohost_user_id')
          .limit(1);

        if (!error) {
          const statusDiv = document.getElementById('status');
          statusDiv.className = 'status success';
          statusDiv.textContent = '‚úÖ Migration already applied! Co-host features are ready.';
          document.getElementById('runButton').textContent = 'Migration Complete ‚úì';
        }
      } catch (e) {
        // Column doesn't exist yet
      }
    });
  </script>
</body>
</html>
